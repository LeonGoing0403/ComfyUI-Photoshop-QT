import{app}from'../../scripts/app.js';import{api}from'../../scripts/api.js';import{cmd_openWorkflow}from'./c111c89b.js';import{findAvailableNodeInGraph,setNodeValue}from'./4b7e7051.js';import{setPageData}from'./store/71860c77.js';let lastNodeInfo=null;class LeonSocket{static ['instance']=null;constructor(_0x45bddd){function _0x1740f2(_0x5342d0,_0x1ecaae){return _0x545a(_0x1ecaae-0x35c,_0x5342d0);}if(LeonSocket[_0x1740f2(0x368,0x35c)])return LeonSocket['instance'];return this['socket']=null,this[_0x1740f2(0x35e,0x35d)]=_0x45bddd,this['connect'](),LeonSocket['instance']=this,this;}['isValidUrl'](_0x3a617e){try{return new URL(_0x3a617e),!![];}catch(_0x4f5fe0){return![];}}['connect'](){function _0x57fe05(_0x2891e4,_0x4381c4){return _0x545a(_0x4381c4- -0x375,_0x2891e4);}try{let _0x5e20dd=location['origin'];if(!this['isValidUrl'](_0x5e20dd)){console['log']('path_comfyui无效',_0x5e20dd);return;}if(typeof io===_0x57fe05(-0x39c,-0x373)){console['error']('socket.io\x20客户端未找到，无法建立连接');return;}return this['socket']=io(_0x5e20dd,{'path':'/leon-ps/','query':{'deviceType':'cf_web'},'reconnection':!![],'reconnectionAttempts':0x5,'reconnectionDelay':0x3e8,'timeout':0x2710,'forceNew':!![],'autoConnect':!![],'auth':{'webType':this['webtype']}}),window['leonSocket']=this,this['setupEventListeners'](),this['socket'];}catch(_0x3bfa54){return console['log']('socket连接失败',_0x3bfa54),null;}}['setupEventListeners'](){this['socket']['on']('connect',()=>{console[_0x50ef56(-0x1a6,-0x17f)]('Socket连接成功，socket\x20id:',this['socket']['id']);function _0x50ef56(_0x5a9d7c,_0x4a3d8c){return _0x545a(_0x4a3d8c- -0x182,_0x5a9d7c);}this['sendToPyServer']('listenIOMessage',{'message':'Webview端的socket连接成功'});}),this[_0x110b1a(-0x20b,-0x1ef)]['on']('registered',_0x3e7b20=>{function _0x14c859(_0x3ec195,_0x51707e){return _0x545a(_0x51707e-0x214,_0x3ec195);}console[_0x14c859(0x20f,0x217)]('注册成功，服务器返回:',_0x3e7b20);}),this[_0x110b1a(-0x1fd,-0x1ef)]['on']('error',_0x41b044=>{console['error']('收到服务器错误:',_0x41b044);}),this['socket']['on'](_0x110b1a(-0x1fc,-0x1ee),_0xc043eb=>{function _0x41da50(_0x13ca3d,_0xc91b47){return _0x545a(_0x13ca3d-0x140,_0xc91b47);}console[_0x41da50(0x143,0x165)](_0x41da50(0x146,0x14e),_0xc043eb);}),this['socket']['on']('close_all_workflows',()=>{console['log']('关闭所有工作流:');for(const _0x306c96 of window[_0x18e099(-0x252,-0x241)]['extensionManager']['workflow']['workflows']){_0x306c96[_0x18e099(-0x23d,-0x240)]&&(console[_0x18e099(-0x245,-0x245)]('wf13313',_0x306c96['path']),window['app']['extensionManager']['workflow']['closeWorkflow'](_0x306c96));}function _0x18e099(_0x33b598,_0x31ab8d){return _0x545a(_0x31ab8d- -0x248,_0x33b598);}const _0x3adce6=window[_0x18e099(-0x23a,-0x241)]['extensionManager'][_0x18e099(-0x25f,-0x23f)][_0x18e099(-0x261,-0x23e)]();window['app']['extensionManager'][_0x18e099(-0x24e,-0x23f)]['openWorkflow'](_0x3adce6);}),this['socket']['on']('close_workflow_web',_0x7f5cd=>{console['log']('工作流关闭:',_0x7f5cd);for(const _0x39fb02 of window[_0x4d8e5a(-0x131,-0x10c)]['extensionManager'][_0x4d8e5a(-0x12f,-0x132)]['workflows']){_0x39fb02['fullFilename']===_0x7f5cd['data']['workflowPath']&&(console['log'](_0x4d8e5a(-0x12d,-0x152),_0x39fb02['path']),window['app'][_0x4d8e5a(-0x12c,-0x133)][_0x4d8e5a(-0x12f,-0x128)][_0x4d8e5a(-0x12b,-0x147)](_0x39fb02));}function _0x4d8e5a(_0x13ee7d,_0x3dc599){return _0x545a(_0x13ee7d- -0x138,_0x3dc599);}window['sendToPyServer'](_0x4d8e5a(-0x12a,-0x10e),{'message':'工作流关闭'});}),this['socket']['on']('setSocketMapReady',_0x470298=>{function _0x3d6997(_0x176c32,_0x1cb156){return _0x545a(_0x176c32- -0x26b,_0x1cb156);}console['log'](_0x3d6997(-0x25c,-0x231),_0x470298);});function _0x110b1a(_0x18ff9d,_0xb92b86){return _0x545a(_0xb92b86- -0x1f3,_0x18ff9d);}this['socket']['on'](_0x110b1a(-0x1b4,-0x1e3),_0x4088b0=>{console['log'](_0x13674d(-0x2a,-0x54),_0x4088b0);function _0x13674d(_0x4c2f71,_0x1ae975){return _0x545a(_0x1ae975- -0x65,_0x4c2f71);}setPageData(_0x4088b0['data'][_0x13674d(-0x7a,-0x53)],'nodeInfo',_0x4088b0['data'][_0x13674d(-0x65,-0x52)],'backend'),window['app']&&window['app']['graph']?(console['log'](_0x13674d(-0x5a,-0x51)),setNodeValue(window[_0x13674d(-0x47,-0x5e)]['graph'],_0x4088b0[_0x13674d(-0x3e,-0x50)][_0x13674d(-0x50,-0x52)])):console['error']('app.graph未就绪，无法设置节点值');}),this['socket']['on']('open_workflow',_0xdc606f=>{function _0x2171f9(_0x2b4e89,_0x44425d){return _0x545a(_0x44425d- -0x3e3,_0x2b4e89);}if(window['app']&&app['api']&&window[_0x2171f9(-0x3fa,-0x3dc)][_0x2171f9(-0x3cd,-0x3cd)]&&document[_0x2171f9(-0x3c6,-0x3cc)](_0x2171f9(-0x3fc,-0x3cb))&&document['querySelector']('.comfy-menu'))try{const _0x55fe4b=_0xdc606f[_0x2171f9(-0x3f3,-0x3ce)]['workflowName'],_0x1d56a1=_0xdc606f['data'][_0x2171f9(-0x3e5,-0x3ca)],_0x5d06a9=_0xdc606f[_0x2171f9(-0x3ff,-0x3ce)]['mode'];console['log'](_0x2171f9(-0x3db,-0x3c9)+_0x55fe4b),cmd_openWorkflow(_0x1d56a1,_0x55fe4b,_0x5d06a9)['then'](_0x54c2c0=>{window['wfName']=_0x55fe4b;let _0x50a8c0=null;setTimeout(()=>{function _0x54ee2a(_0x7b2a2b,_0x4fe09c){return _0x545a(_0x7b2a2b-0x29e,_0x4fe09c);}_0x50a8c0=findAvailableNodeInGraph(window[_0x54ee2a(0x2a5,0x284)]['graph']);},0xc8),setTimeout(()=>{function _0x101e77(_0x17d1c0,_0x5bf573){return _0x545a(_0x5bf573-0xab,_0x17d1c0);}_0x50a8c0=findAvailableNodeInGraph(window['app'][_0x101e77(0xf0,0xc6)]);},0x12c),setTimeout(()=>{_0x50a8c0=findAvailableNodeInGraph(window['app'][_0x45e3d0(0x139,0x14c)]);function _0x45e3d0(_0x5a6ea5,_0x56e156){return _0x545a(_0x5a6ea5-0x11e,_0x56e156);}this['sendToPyServer'](_0x45e3d0(0x13a,0x110),{'message':!![],'wfName':_0x55fe4b,'wfopenNode':_0x50a8c0});window[_0x45e3d0(0x13b,0x16b)]&&window['sendToPyServer']('listenIOMessage',{'wfOpenState':'web端：'+_0x55fe4b+'工作流打开成功'});setPageData(_0x55fe4b,'nodeInfo',_0x50a8c0,_0x45e3d0(0x13c,0x136));const _0x1ece57=getWorkflowCount();window[_0x45e3d0(0x13b,0x10a)]('setWorkflowCount',{'number':_0x1ece57});},0x1f4);})['catch'](_0x2d21a6=>{console['error']('加载工作流出错:',_0x2d21a6),this['sendToPyServer']('workflow_loaded_State',{'message':![],'wfName':_0x55fe4b,'wfopenNode':''});function _0x535275(_0x1f2359,_0x276bf9){return _0x545a(_0x276bf9- -0x1b0,_0x1f2359);}this[_0x535275(-0x178,-0x193)]('errorMessagesCollecter',{'type':'PluginClientError','message':'工作流加载失败:'+_0x2d21a6['toString']()});});}catch(_0x3dfe44){this[_0x2171f9(-0x3e9,-0x3c6)]('errorMessagesCollecter',{'type':'PluginClientProcessError','message':_0x2171f9(-0x3e7,-0x3c4)+_0x3dfe44});}else this['sendToPyServer']('errorMessagesCollecter',{'type':'PluginClientStatusError','message':'ComfyUI应用未就绪，无法加载工作流'});}),this[_0x110b1a(-0x204,-0x1ef)]['on']('message',_0x5cafdb=>{function _0x38c3c6(_0x2b0710,_0x1e39dc){return _0x545a(_0x2b0710- -0xa4,_0x1e39dc);}console[_0x38c3c6(-0xa1,-0x7f)]('收到服务器消息:',_0x5cafdb);switch(_0x5cafdb['type']){case _0x38c3c6(-0x84,-0xab):console[_0x38c3c6(-0xa1,-0x9a)]('工作流更新:',_0x5cafdb);break;case _0x38c3c6(-0x83,-0x97):console[_0x38c3c6(-0xa1,-0x70)]('状态更新:',_0x5cafdb);break;case'window_name_confirmed':console['log'](_0x38c3c6(-0x82,-0x6f),_0x5cafdb['data']);break;default:console[_0x38c3c6(-0xa1,-0xa7)]('未知消息类型:',_0x5cafdb);}}),this['socket']['on']('callWebSetSid',_0x5b9ee0=>{console['log']('获取到webSid为',_0x5b9ee0[_0x95bfab(-0x1e1,-0x1b8)]);function _0x95bfab(_0x45ba62,_0x405fa6){return _0x545a(_0x45ba62- -0x1f6,_0x405fa6);}window[_0x95bfab(-0x1d3,-0x1dd)]=_0x5b9ee0['data'];}),this[_0x110b1a(-0x208,-0x1ef)]['on']('connect_error',_0x5c27a0=>{function _0xb8e6b2(_0x29a48d,_0x5895f8){return _0x545a(_0x5895f8-0x30d,_0x29a48d);}console['log'](_0xb8e6b2(0x344,0x331),_0x5c27a0);}),this['socket']['on']('disconnect',_0xff1667=>{console['log']('socket连接断开',_0xff1667);});}['sendToPyServer'](_0x1d7f90,_0x2cf930){if(!this['socket']||!this[_0x5d532b(-0x1c1,-0x19a)]['connected'])return console['error'](_0x5d532b(-0x1a0,-0x178)),![];function _0x5d532b(_0x1b3eee,_0x5b8dc7){return _0x545a(_0x1b3eee- -0x1c5,_0x5b8dc7);}try{console['log']('向Python服务器发送\x20'+_0x1d7f90+_0x5d532b(-0x19f,-0x19b),_0x2cf930),this['socket']['emit'](_0x1d7f90,_0x2cf930);return!![];F;}catch(_0xad91f2){return console['error']('发送\x20'+_0x1d7f90+'\x20消息失败:',_0xad91f2),![];}}['getSocketStatus'](){function _0x508340(_0x43253e,_0x52e515){return _0x545a(_0x43253e- -0x26e,_0x52e515);}return{'connected':this[_0x508340(-0x26a,-0x262)]?.[_0x508340(-0x247,-0x228)]||![],'id':this['socket']?.['id']||null};}static['getInstance'](_0x3e7f57){function _0x2496d4(_0x1a6a79,_0x2de387){return _0x545a(_0x1a6a79- -0x2fa,_0x2de387);}if(!LeonSocket['instance'])return new LeonSocket(_0x3e7f57);return LeonSocket[_0x2496d4(-0x2fa,-0x2f7)];}}let sk_web2cf=null,sk=null,initnodes=null;export async function getSysInfo(){const _0x52c47c=await app[_0x35c0ee(-0x372,-0x383)][_0x35c0ee(-0x37e,-0x382)](_0x35c0ee(-0x378,-0x381),{'method':_0x35c0ee(-0x393,-0x380)});let _0x3a1dca=await _0x52c47c[_0x35c0ee(-0x380,-0x37f)]();function _0x35c0ee(_0x3dabc4,_0x57f33b){return _0x545a(_0x57f33b- -0x3ab,_0x3dabc4);}return _0x3a1dca;}function _0x1bab76(_0x1fe1c3,_0x1ebc44){return _0x545a(_0x1ebc44-0x29f,_0x1fe1c3);}function loadSocketIO(_0x3931a9){if(typeof io!=='undefined'){console[_0x3bc552(-0x3ca,-0x3f5)]('socket.io\x20已经加载,\x20直接使用'),LeonSocket['getInstance'](_0x3931a9);return;}console[_0x3bc552(-0x3ca,-0x3eb)]('尝试动态加载\x20socket.io-client');function _0x3bc552(_0x5a9971,_0x3d98aa){return _0x545a(_0x5a9971- -0x3cd,_0x3d98aa);}const _0x5224ca=document[_0x3bc552(-0x3a0,-0x38f)]('script');_0x5224ca['src']='https://cdn.socket.io/4.6.0/socket.io.min.js',_0x5224ca['integrity']='sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+',_0x5224ca['crossOrigin']='anonymous',_0x5224ca[_0x3bc552(-0x39f,-0x3ad)]=()=>{function _0x574989(_0x1d5cd1,_0x4fbfb6){return _0x545a(_0x4fbfb6- -0x2ca,_0x1d5cd1);}LeonSocket[_0x574989(-0x288,-0x29b)](_0x3931a9);},_0x5224ca[_0x3bc552(-0x39d,-0x3aa)]=_0x5c2f63=>{console['error']('加载\x20socket.io-client\x20失败:',_0x5c2f63);},document['head']['appendChild'](_0x5224ca);}window['sendToPyServer']=function(_0xcca19e,_0x9b2916){function _0x44b927(_0x5269a3,_0x34af06){return _0x545a(_0x34af06-0x3a0,_0x5269a3);}return LeonSocket[_0x44b927(0x397,0x3a0)]?.['sendToPyServer'](_0xcca19e,_0x9b2916)||![];},window[_0x1bab76(0x2c5,0x2d0)]=function(){function _0x11a9bc(_0x507c30,_0x425f10){return _0x545a(_0x425f10-0x17b,_0x507c30);}return LeonSocket['instance']?.[_0x11a9bc(0x19a,0x1ac)]()||{'connected':![],'id':null};};function _0x4014(){const _0x3c085c=['instance','webtype','undefined','log','socket','openWorkflow_result','工作流打开结果:','app','isLoaded','workflow','createTemporary','wf22222','extensionManager','closeWorkflow','listenIOMessage','setSocketMapReady:','workflowNodesToWeb','workflowNodesToWeb222222222222:','workflowName','workflowNodes','设置节点值','data','vueAppReady','querySelector','.litegraph','cdk','正在尝试加载工作流:\x20','graph','workflow_loaded_State','sendToPyServer','backend','工作流加载失败','workflow_update','status_update','窗口名称已确认:','webSid','socket连接失败','Socket未连接，无法发送消息','\x20消息:','connected','api','fetchApi','/system_stats','GET','json','createElement','onload','getInstance','onerror','getSocketStatus','message','once','errorMessagesCollecter','comfy端：后台加载完成','comfy端：后台未加载完成,持续监听','detail','addEventListener','status','prompt_error','value','progress','execution_cached','execution_error','Run_PyBackendViewDialogError','parse','type','[execution_interrupted]\x20中断执行:','queuePrompt','非uxpHost访问','uxpHost访问成功','graphChanged','length','Running','comfy端：收到插件消息:','then','error','setSocketMap失败:\x20','wsid:','setWindowNameSuccess','clearAllClientID','removeItem','clientId','comfy端：收到setWindowNameBeforeRun:','name','checkWebClientIdSuccess','cmdRunSendToPlugin','停止成功','临时节点删除成功','show','dialog','检测到\x20dialog.show()\x20被调用，参数:','listenErrorDialog','Run_WebViewDialogError','apply','nodeInfo','workflowInfo','wfName','call','filter','PsImageChooser','nodeType','currentWFName','currentWFInputNodes'];_0x4014=function(){return _0x3c085c;};return _0x4014();}function waitSetMapReady(_0x2f489a,_0x5863ad,_0x40ef1a){return new Promise((_0x4ed09b,_0x4952c6)=>{const _0x57a151=_0x582c3d=>{LeonSocket[_0x13ade6(0x128,0x159)]['socket']['off']('setSocketMapReady',_0x57a151);function _0x13ade6(_0x1c6994,_0x330d13){return _0x545a(_0x1c6994-0x128,_0x330d13);}clearTimeout(_0x1d28be),_0x582c3d&&_0x582c3d['data']===!![]?_0x4ed09b(_0x582c3d):_0x4952c6(new Error(_0x582c3d?.[_0x13ade6(0x15a,0x13e)]||'未知错误'));};LeonSocket['instance']['socket'][_0x1cb2e7(0x6,0x26)]('setSocketMapReady',_0x57a151);const _0x1d28be=setTimeout(()=>{function _0x80ed8(_0x5a05e9,_0xf8e0fb){return _0x545a(_0x5a05e9-0x4d,_0xf8e0fb);}LeonSocket[_0x80ed8(0x4d,0x51)][_0x80ed8(0x51,0x3f)]['off']('setSocketMapReady',_0x57a151),_0x4952c6(new Error('setSocketMap请求超时'));},0x2710);function _0x1cb2e7(_0x5814ae,_0x3e47a7){return _0x545a(_0x5814ae- -0x2d,_0x3e47a7);}window['sendToPyServer']('setSocketMap',{'pluginSid':_0x2f489a,'webSid':_0x5863ad,'windowName':_0x40ef1a});});}function sendMessageToPlugin(_0x1bf0af){function _0x3c9b02(_0x46b6a7,_0x235d46){return _0x545a(_0x235d46-0x139,_0x46b6a7);}typeof uxpHost!==_0x3c9b02(0x169,0x13b)&&uxpHost['postMessage'](_0x1bf0af);}function getWorkflowCount(){function _0x924d40(_0x35af6b,_0x5bbbea){return _0x545a(_0x35af6b-0x99,_0x5bbbea);}try{const _0x4e817f=document[_0x924d40(0xb0,0x8c)]('.p-badge.p-component.p-badge-circle'),_0x381834=_0x4e817f['textContent'];return _0x381834;}catch(_0x53bfc0){sendToPyServer(_0x924d40(0xcd,0xec),{'type':'getWorkflowCountError','message':'获取工作流数量失败'+_0x53bfc0});}}const waitForAppReady=()=>{return new Promise((_0x34b789,_0x2f1565)=>{const _0x35ca2d=setInterval(()=>{function _0x2e2b9b(_0x27dc73,_0x1e78d1){return _0x545a(_0x1e78d1- -0x97,_0x27dc73);}window['app']&&window['app']['vueAppReady']&&document['querySelector'](_0x2e2b9b(-0xa9,-0x7f))&&document['querySelector']('.comfy-menu')?(console['log'](_0x2e2b9b(-0x8f,-0x62)),dispatchEvent(new Event('pageLoadedReady')),sendMessageToPlugin({'type':'backendIsReady'}),clearInterval(_0x35ca2d),clearTimeout(_0x45d7c6),_0x34b789('加载成功')):console['log'](_0x2e2b9b(-0x71,-0x61));},0x1f4),_0x45d7c6=setTimeout(()=>{clearInterval(_0x35ca2d);function _0x20a1e9(_0x472928,_0x223e51){return _0x545a(_0x223e51- -0x1c2,_0x472928);}sendToPyServer(_0x20a1e9(-0x1a1,-0x18e),{'type':'waitForAppReadyError','message':'后台加载超时'}),_0x2f1565(new Error('超时'));},0x927c0);});};function addWebSocketStateListener(){api['addEventListener']('execution_start',_0x3fc5f6=>{console['log']('execution_start',_0x3fc5f6);function _0x137ec8(_0x33a5ce,_0x23ae91){return _0x545a(_0x23ae91- -0x13e,_0x33a5ce);}const _0x28f1ef=_0x3fc5f6[_0x137ec8(-0xf1,-0x107)]['prompt_id'];sendMessageToPlugin({'type':'execution_start','data':_0x28f1ef});}),api[_0x12d9ba(0x416,0x435)](_0x12d9ba(0x417,0x405),_0x2deac7=>{const _0x3197a0=_0x2deac7[_0x85e9cb(0x226,0x237)]['exec_info']['queue_remaining'];function _0x85e9cb(_0x12401d,_0x4fc32a){return _0x545a(_0x12401d-0x1ef,_0x4fc32a);}sendMessageToPlugin({'type':'status','data':_0x3197a0});}),api['addEventListener']('prompt_error',_0x235e95=>{function _0x108d55(_0x468959,_0x4e502f){return _0x545a(_0x468959-0x2a,_0x4e502f);}console['log']('prompt_error',_0x235e95),sendMessageToPlugin({'type':_0x108d55(0x64,0x50),'data':_0x235e95[_0x108d55(0x61,0x8e)]});});function _0x12d9ba(_0x5e22db,_0x1ba659){return _0x545a(_0x5e22db-0x3de,_0x1ba659);}api[_0x12d9ba(0x416,0x3e3)]('progress',_0x3a89cc=>{const _0x59d82e=_0x3a89cc['detail']['node'],_0x25a6c4=_0x3a89cc['detail'][_0x1c720c(-0xa,0x1e)],_0x3f5aed=_0x3a89cc['detail']['max'];console[_0x1c720c(-0x42,-0x54)]('progress',_0x3a89cc);function _0x1c720c(_0x34ad74,_0x3a8135){return _0x545a(_0x34ad74- -0x45,_0x3a8135);}sendMessageToPlugin({'type':_0x1c720c(-0x9,0x0),'data':{'node':_0x59d82e,'value':_0x25a6c4,'max':_0x3f5aed}});}),api['addEventListener']('executing',_0x838b0e=>{console['log']('executing',_0x838b0e);function _0xadc14a(_0xcba29f,_0x4fec28){return _0x545a(_0x4fec28- -0xb8,_0xcba29f);}const _0x522fbd=_0x838b0e['detail'];sendMessageToPlugin({'type':'executing','data':_0x522fbd}),api['addEventListener']('execution_cached',_0x3a4f4e=>{const _0x57b404=_0x3a4f4e[_0x5c9511(0x2e2,0x2eb)];console['log'](_0x5c9511(0x2be,0x2f1),_0x57b404);function _0x5c9511(_0x5ea621,_0x40d5ab){return _0x545a(_0x40d5ab-0x2b4,_0x5ea621);}sendMessageToPlugin({'type':'execution_cached','data':_0x57b404});}),api['addEventListener'](_0xadc14a(-0x9e,-0x7a),_0x3c18ce=>{function _0x4cf3be(_0x430207,_0x3c7945){return _0x545a(_0x3c7945-0xfd,_0x430207);}const _0x5a85ec=_0x3c18ce['detail'];sendMessageToPlugin({'type':'execution_error','data':_0x5a85ec}),window['sendToPyServer']('errorMessagesCollecter',{'type':_0x4cf3be(0x16f,0x13c),'message':_0x5a85ec});}),setTimeout(()=>{function _0xa67635(_0x87f137,_0x5d79f2){return _0x545a(_0x5d79f2-0x20f,_0x87f137);}api[_0xa67635(0x220,0x213)]['onmessage']=function(_0x380bf5){function _0x329859(_0x40e519,_0x1283f1){return _0x545a(_0x40e519-0x33,_0x1283f1);}const _0x16bd5c=JSON[_0x329859(0x73,0x61)](_0x380bf5['data']);if(_0x16bd5c[_0x329859(0x74,0x68)]==='execution_success')console[_0x329859(0x36,0x5d)]('[execution_success]\x20执行成功:','prompt_id:',_0x16bd5c['data']['prompt_id']),sendMessageToPlugin({'type':'execution_success','data':_0x16bd5c});else _0x16bd5c['type']==='execution_interrupted'&&(console['log'](_0x329859(0x75,0xa5),_0x16bd5c),sendMessageToPlugin({'type':'execution_interrupted','data':_0x16bd5c}));};},0x1f4);});}function hookQueueMethod(){const _0x2e88dc=app[_0x245cd1(-0x1e4,-0x1df)]['queuePrompt'];function _0x245cd1(_0x1e6972,_0x5cdd5d){return _0x545a(_0x5cdd5d- -0x207,_0x1e6972);}app[_0x245cd1(-0x1ae,-0x1df)][_0x245cd1(-0x19d,-0x1c4)]=async function(_0x2bb11c,_0x18fc0d){const _0x44cf66=_0x18fc0d['output'],_0x3d34af=Object['keys'](_0x44cf66)['length'];return sendMessageToPlugin({'type':'queuePromptTotalNodes','data':_0x3d34af}),await _0x2e88dc['apply'](app['api'],[...arguments]);};}function _0x545a(_0x401457,_0x545a14){const _0x566a66=_0x4014();return _0x545a=function(_0x322802,_0x250aad){_0x322802=_0x322802-0x0;let _0xc67ef7=_0x566a66[_0x322802];return _0xc67ef7;},_0x545a(_0x401457,_0x545a14);}if(typeof uxpHost=='undefined')console['log'](_0x1bab76(0x2f7,0x2e3)),loadSocketIO('cf_web_normal'),listenErrorDialog(),addWebSocketStateListener();else try{console['log'](_0x1bab76(0x2d6,0x2e4)),sendMessageToPlugin({'type':'uxpHostSuccess'}),loadSocketIO('cf_web_uxp'),listenErrorDialog(),addWebSocketStateListener(),hookQueueMethod(),api['addEventListener'](_0x1bab76(0x2cd,0x2e5),async()=>{triggerGraphChanged();});async function getQueueCount(){function _0x43a1b0(_0x31fd74,_0x3dc6bb){return _0x545a(_0x31fd74-0x368,_0x3dc6bb);}const _0x483d17=await window['app']['api']['getQueue']();if(_0x483d17){let _0x39b925=_0x483d17['Pending'][_0x43a1b0(0x3af,0x3a3)],_0x4208a1=_0x483d17[_0x43a1b0(0x3b0,0x3bb)]['length'];return _0x39b925+_0x4208a1;}else return 0x0;}import('./740e9b81.js')['then'](_0x37dfda=>{_0x37dfda['default'](leonPS);}),window['addEventListener'](_0x1bab76(0x2cf,0x2d1),async _0x354c90=>{console['log'](_0x314161(-0x37a,-0x36e),_0x354c90);function _0x314161(_0x352cf2,_0x304c60){return _0x545a(_0x352cf2- -0x3c3,_0x304c60);}try{const _0x2becd0=JSON['parse'](_0x354c90['data']);_0x2becd0['type']==='run'&&(await window[_0x314161(-0x3bc,-0x3b6)]['queuePrompt'](),console['log']('comfy端：收到run:'));_0x2becd0[_0x314161(-0x382,-0x356)]==='cmdCloseErrorDialog'&&(console['log']('comfy端：收到cmdCloseErrorDialog:'),window[_0x314161(-0x3bc,-0x3e6)]['ui']['dialog']['close'](),sendMessageToPlugin({'type':'cmdCloseErrorDialogSuccess'}));if(_0x2becd0[_0x314161(-0x382,-0x38d)]==='getCustomList'){console['log']('comfy端：收到getCustomList:');const _0x530678=await app['api']['listUserDataFullInfo']('workflows');sendMessageToPlugin({'type':'getCustomListSuccess','data':_0x530678});}if(_0x2becd0[_0x314161(-0x382,-0x377)]==='setPagePluginSid'){console['log']('comfy端：收到setPagePluginSid:',_0x2becd0['data']),window['pluginSid']=_0x2becd0['data'];let _0x1d4b98=window['pluginSid'],_0x41db91=window['webSid'],_0x181cf1=window['name'];_0x1d4b98&&_0x41db91?waitSetMapReady(_0x1d4b98,_0x41db91,_0x181cf1)[_0x314161(-0x379,-0x3ab)](_0x4d9fd2=>{console['log']('comfy端：!!!!!setSocketMap成功',_0x4d9fd2);const _0x273007=getWorkflowCount();window['sendToPyServer']('setWorkflowCount',{'number':_0x273007});})['catch'](_0x366948=>{function _0x1c98d8(_0x518760,_0x31d5f9){return _0x545a(_0x518760-0xc4,_0x31d5f9);}console[_0x1c98d8(0x10f,0x119)]('comfy端：setSocketMap失败',_0x366948),window[_0x1c98d8(0xe1,0x108)]('errorMessagesCollecter',{'type':'setSocketMapError','message':_0x1c98d8(0x110,0xf9)+_0x366948['toString']()});}):(console['log']('comfy端：pluginSid或webSid未设置，无法发送消息','psid:',_0x1d4b98,_0x314161(-0x376,-0x363),_0x41db91),sendMessageToPlugin({'type':'setSocketMapError','error':'pluginSid或webSid未设置'}));}_0x2becd0['type']==='setWindowName'&&(window['name']!==_0x2becd0['data']?window['name']=_0x2becd0['data']:console['log']('comfy端：window.name已经正确设置为:',window['name']),sendMessageToPlugin({'type':_0x314161(-0x375,-0x348)}));_0x2becd0[_0x314161(-0x382,-0x3a8)]===_0x314161(-0x374,-0x368)&&(window['name']='',localStorage[_0x314161(-0x373,-0x39d)](_0x314161(-0x372,-0x366)),sendMessageToPlugin({'type':'clearAllClientIDSuccess'}));if(_0x2becd0['type']==='setWindowNameBeforeRun'){console[_0x314161(-0x3c0,-0x3da)](_0x314161(-0x371,-0x37f));let _0x54e08a=_0x2becd0['data'];window['name']=_0x54e08a,sendMessageToPlugin({'type':'setWindowNameBeforeRunSuccess','data':window['name']});}if(_0x2becd0['type']==='checkWebClientId'){console['log']('comfy端：收到checkWebClientId:');let _0x28e73a=_0x2becd0[_0x314161(-0x372,-0x371)],_0x2a985d=window[_0x314161(-0x370,-0x33f)];sendMessageToPlugin({'type':_0x314161(-0x36f,-0x37c),'data':_0x2a985d});}if(_0x2becd0['type']===_0x314161(-0x36e,-0x39a)){let _0x9de14e=_0x2becd0['batchCount'];window['app']['queuePrompt'](0x0,_0x9de14e);}if(_0x2becd0['type']==='cmdStopSendToPlugin'){let _0x49ddb0=0x0;getQueueCount()['then'](async _0x388041=>{function _0x213f07(_0x90064f,_0x53e991){return _0x545a(_0x90064f-0x2f1,_0x53e991);}while(!![]){if(_0x388041>0x0)window['app']['api']['interrupt'](),_0x388041=await getQueueCount();else{console['log'](_0x213f07(0x347,0x35c));break;}await new Promise(_0x172e94=>setTimeout(_0x172e94,0x1f4));}});}}catch(_0x415d4c){console['error']('处理插件消息出错:',_0x415d4c);}}),waitForAppReady()['then'](()=>{console['log']('comfy端：页面加载完成');});}catch(_0x58737c){console['error']('comfy端：页面加载失败',_0x58737c),window['sendToPyServer']('errorMessagesCollecter',{'type':'WebClientError','message':'页面加载失败,'+_0x58737c});}function forceTriggerGraphChanged(){function _0x1a2b28(_0x3d6a8b,_0x33c769){return _0x545a(_0x33c769-0x40,_0x3d6a8b);}if(window&&LiteGraph){const _0x380afe=LiteGraph['createNode']('LeonEmptyNode'),_0x558cbc=window[_0x1a2b28(0x3d,0x47)]['graph']['add'](_0x380afe);if(_0x558cbc['id']){console[_0x1a2b28(0x35,0x43)]('临时节点创建成功',_0x558cbc);const _0x2c1fe0=app['graph']['nodes']['find'](_0x1f9f87=>_0x1f9f87['id']===_0x558cbc['id']);_0x2c1fe0&&(app['graph']['remove'](_0x2c1fe0),console['log'](_0x1a2b28(0x94,0x97),_0x2c1fe0));}}}function listenErrorDialog(){const _0x1c9469=app['ui']['dialog'][_0x54ee4a(-0x353,-0x330)];function _0x54ee4a(_0x493963,_0x5e3c8a){return _0x545a(_0x493963- -0x3ab,_0x5e3c8a);}app['ui'][_0x54ee4a(-0x352,-0x31e)]['show']=function(..._0x3b9580){function _0x3fc13a(_0x45018b,_0x221ead){return _0x545a(_0x45018b- -0x2bd,_0x221ead);}return console['log'](_0x3fc13a(-0x263,-0x266),..._0x3b9580),sendMessageToPlugin({'type':_0x3fc13a(-0x262,-0x28d),'data':{'data':_0x3b9580[0x0]}}),window['sendToPyServer']('errorMessagesCollecter',{'type':_0x3fc13a(-0x261,-0x288),'message':_0x3b9580[0x0]}),_0x1c9469[_0x3fc13a(-0x260,-0x25d)](this,_0x3b9580);};}function triggerGraphChanged(){function _0x3faa6e(_0x2de2e7,_0x31c4d6){return _0x545a(_0x31c4d6- -0x357,_0x2de2e7);}try{!window['name']&&window['sendToPyServer'](_0x3faa6e(-0x31c,-0x323),{'type':'WebClientError','message':'window.name未设置'}),setTimeout(()=>{const _0x53ebcf=findAvailableNodeInGraph(app[_0x5f34eb(0x376,0x377)]);console['log']('comfy端：当前页面收到画面改变的信息号graphChanged',_0x53ebcf),setPageData(window['name'],_0x5f34eb(0x3b9,0x3c9),_0x53ebcf);function _0x5f34eb(_0x29ccc3,_0x1d501f){return _0x545a(_0x29ccc3-0x35b,_0x1d501f);}!window['wfName']&&(console['log']('setPageData',app['extensionManager'][_0x5f34eb(0x364,0x375)]['activeWorkflow']['fullFilename']),window['wfName']=app['extensionManager']['workflow']['activeWorkflow']['fullFilename']),window[_0x5f34eb(0x378,0x35b)](_0x5f34eb(0x3ba,0x3d8),{'data':_0x53ebcf,'flag':_0x5f34eb(0x3a1,0x3ae),'wfName':window[_0x5f34eb(0x3bb,0x3b0)]}),lastNodeInfo=_0x53ebcf;},0x12c);}catch(_0x4b3998){window[_0x3faa6e(-0x32e,-0x33a)]('errorMessagesCollecter',{'type':'WebClientError','message':'处理graphChanged事件出错,'+_0x4b3998});}}const originalGraphToPrompt=app['graphToPrompt'];app['graphToPrompt']=async function(){forceTriggerGraphChanged();const _0x40c958=await originalGraphToPrompt[_0x37a6ef(0x26d,0x243)](app);_0x40c958[_0x37a6ef(0x215,0x219)]['leonId']=window['name'];const _0x30026d=findAvailableNodeInGraph(app['graph']);window['currentWFInputNodes']=_0x30026d[_0x37a6ef(0x26e,0x27e)](_0x377c08=>String(_0x377c08['nodeType'])!=='LoadImage'&&String(_0x377c08['nodeType'])!==_0x37a6ef(0x26f,0x274)&&String(_0x377c08[_0x37a6ef(0x270,0x26d)])!=='PsPreviewImage'&&String(_0x377c08['nodeType'])!=='PsSaveImage'&&String(_0x377c08['nodeType'])!=='LoadImageMask');function _0x37a6ef(_0x144dd0,_0x294624){return _0x545a(_0x144dd0-0x20c,_0x294624);}console['log']('fullFilename',window['app']['extensionManager'][_0x37a6ef(0x215,0x1fe)]['activeWorkflow']['fullFilename']);const _0x3f6d3d=window[_0x37a6ef(0x213,0x208)]['extensionManager'][_0x37a6ef(0x215,0x21e)]['activeWorkflow']['fullFilename'];return _0x3f6d3d&&(_0x40c958['workflow'][_0x37a6ef(0x271,0x240)]=_0x3f6d3d),_0x40c958['workflow']['currentWFInputNodes']=window[_0x37a6ef(0x272,0x258)],_0x40c958;};export default LeonSocket;